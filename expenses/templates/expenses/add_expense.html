{% extends 'expenses/base.html' %}
{% load static %}
{% block title %}Add Expense - SmartExpense{% endblock %}

{% block content %}
<div class="container">
  <div class="expense-form card p-4 shadow-sm mx-auto" style="max-width: 600px; border-radius: 12px;">
    <h3 class="text-center text-success mb-4">Add New Expense</h3>

    <!-- Budget warning -->
    <div id="budget-warning" class="alert alert-warning d-none">
      Adding this expense will exceed your budget.
    </div>

    <!-- Django form -->
    <form method="POST">
      {% csrf_token %}

      <div class="mb-3">
        <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
        {{ form.title }}
      </div>

      <div class="mb-3">
        <label for="{{ form.amount.id_for_label }}" class="form-label">Amount</label>
        {{ form.amount }}
      </div>

      <div class="mb-3">
        <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
        {{ form.date }}
      </div>

      <div class="mb-3">
        <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
        {{ form.category }}
      </div>

      <div class="mb-3">
        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
        {{ form.description }}
      </div>

      <!-- Buttons -->
      <button type="submit" class="btn btn-success w-100">Add Expense</button>
      <a href="{% url 'expense_list' %}" class="btn btn-secondary w-100 mt-2">Back</a>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Fetch current month's total and warn if exceeding budget
  let currentMonthTotal = 0;
  fetch("{% url 'month_total_api' %}")
    .then(r => r.json())
    .then(d => currentMonthTotal = d.month_total);

  const amt = document.querySelector('input[name="amount"]');
  const warn = document.getElementById('budget-warning');
  const monthlyBudget = JSON.parse('{{ monthly_budget_amount|default:"null"|escapejs }}');

  if (amt) {
    amt.addEventListener('input', () => {
      const val = parseFloat(amt.value || 0);
      if (monthlyBudget && (currentMonthTotal + val) >= monthlyBudget) {
        warn.classList.remove('d-none');
      } else {
        warn.classList.add('d-none');
      }
    });
  }
</script>
{% endblock %}
